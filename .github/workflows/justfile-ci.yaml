name: Justfile CI

on:
  push:
    branches: [main, reconfigure_claude]
  pull_request:

permissions:
  contents: read

concurrency:
  group: justfile-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # macOS builds (aligned with build-svn.yaml: macOS-15, macOS-15-intel)
  # ==========================================================================
  macos:
    name: macOS (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, macos-15-large]  # ARM and Intel
    env:
      HOMEBREW_NO_AUTO_UPDATE: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install just autoconf automake pkg-config gcc readline pcre2 xz bzip2 zlib libdeflate curl
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix gcc)/bin" >> $GITHUB_PATH
          echo "CPPFLAGS=-I$(brew --prefix)/include -I$(brew --prefix xz)/include -I$(brew --prefix readline)/include -I$(brew --prefix bzip2)/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix)/lib -L$(brew --prefix xz)/lib -L$(brew --prefix readline)/lib -L$(brew --prefix bzip2)/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix readline)/lib/pkgconfig:$(brew --prefix)/lib/pkgconfig" >> $GITHUB_ENV

      - name: Show versions
        run: |
          just --version
          gfortran --version | head -1
          uname -m

      - name: Configure and build
        run: |
          just configure-fast
          just show-config
          just build-r-min
          just r-version
          just run-expr "R.version.string"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.os }}
          path: /tmp/r-conf-build-*/config.log
          retention-days: 3

      - name: Clean up
        if: always()
        run: just clean-all-builds || true

  # ==========================================================================
  # Linux build (aligned with build-svn.yaml: ubuntu-24.04)
  # ==========================================================================
  linux:
    name: Linux (ubuntu-24.04)
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          mkdir -p ~/.local/bin
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          sudo apt-get update -y
          sudo apt-get install -y build-essential gfortran autoconf pkg-config \
            libreadline-dev libpcre2-dev liblzma-dev libbz2-dev zlib1g-dev \
            libcurl4-openssl-dev libdeflate-dev libtirpc-dev
          echo "CPPFLAGS=-I/usr/include/tirpc" >> $GITHUB_ENV
          echo "LIBS=-ltirpc" >> $GITHUB_ENV

      - name: Show versions
        run: |
          just --version
          gcc --version | head -1
          gfortran --version | head -1

      - name: Configure and build
        run: |
          just configure-fast
          just show-config
          just build-r-min
          just r-version
          just run-expr "R.version.string"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-linux
          path: /tmp/r-conf-build-*/config.log
          retention-days: 3

      - name: Clean up
        if: always()
        run: just clean-all-builds || true

  # ==========================================================================
  # Linux ARM build (aligned with build-svn.yaml ARM matrix)
  # ==========================================================================
  linux-arm:
    name: Linux ARM (ubuntu-24.04-arm)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 45
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          mkdir -p ~/.local/bin
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          sudo apt-get update -y
          sudo apt-get install -y build-essential gfortran autoconf pkg-config \
            libreadline-dev libpcre2-dev liblzma-dev libbz2-dev zlib1g-dev \
            libcurl4-openssl-dev libdeflate-dev libtirpc-dev
          echo "CPPFLAGS=-I/usr/include/tirpc" >> $GITHUB_ENV
          echo "LIBS=-ltirpc" >> $GITHUB_ENV

      - name: Show versions
        run: |
          uname -m
          just --version
          gcc --version | head -1

      - name: Configure and build
        run: |
          just configure-fast
          just show-config
          just build-r-min
          just r-version

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-linux-arm
          path: /tmp/r-conf-build-*/config.log
          retention-days: 3

      - name: Clean up
        if: always()
        run: just clean-all-builds || true
