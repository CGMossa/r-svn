on: [push, pull_request]

name: Build from SVN

concurrency:
  group: ${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  linux:
    name: Linux
    runs-on: ubuntu-24.04${{matrix.ARCH == 'arm' && '-arm' || ''}}
    container:
      image: ${{matrix.OS}}
    env:
      DEBIAN_FRONTEND: noninteractive
      R_CRAN_WEB: "https://cran.rstudio.com"
      CRAN_RSYNC: 'mirrors.nic.cz::CRAN'
    strategy:
      fail-fast: false
      matrix:
        CC: [ gcc, clang ]
        OS: [ 'debian:stable', 'debian:testing' ]
        ARCH: [ 'intel', 'arm']
    steps:
    - name: System dependencies
      run: |
        set -e
        apt-get update -y
        apt-get install -y ${{matrix.CC}} wget locales git rsync gfortran xvfb autoconf pkg-config texinfo texlive-latex-extra texlive-fonts-recommended tk8.6-dev \
        libcurl4-openssl-dev libblas-dev libbz2-dev libicu-dev libjpeg-dev liblapack-dev liblzma-dev libncurses5-dev libpcre2-dev libpng-dev libtiff-dev libcairo2-dev libpango1.0-dev libreadline-dev libxt-dev libtirpc-dev
        localedef -i en_US -f UTF-8 en_US.UTF-8
        echo "LANG=en_US.UTF-8" >> $GITHUB_ENV
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 100

    - name: Prepare
      run: |
        git config --global --add safe.directory $PWD || true
        sed -i.bak 's|$(GIT) svn info|./.github/scripts/svn-info.sh|' Makefile.in
        ./.github/scripts/wget-recommended.sh
        ./.github/scripts/svn-info.sh
    - name: Configure
      run: CC=${{matrix.CC}} CPPFLAGS="-I/usr/include/tirpc" ./configure --enable-R-shlib --with-blas --with-lapack --disable-java

    - name: Build
      run: make

    - name: Check
      run: xvfb-run make check-all

    - name: Print failed tests
      if: always()
      run: tail -n100 tests/*.fail || true

  macos:
    name: MacOS
    strategy:
      fail-fast: false
      matrix:
        OS: [ 'macOS-15', 'macOS-15-intel' ]
    runs-on: ${{matrix.OS}}
    timeout-minutes: 90
    env:
      PKG_CONFIG_PATH: /opt/X11/lib/pkgconfig
      R_CRAN_WEB: "https://cran.rstudio.com"
      CRAN_RSYNC: 'mirrors.nic.cz::CRAN'
      R_TEXI2DVICMD: emulation

    steps:
    - name: Download CRAN system libraries
      run: |
        echo "ARCH=$(uname -m)" >> $GITHUB_ENV
        curl --retry 3 -fsSL https://github.com/r-universe-org/cranlibs/releases/download/2025-01-05/cranlibs-everything.tar.xz -o libs.tar.xz
        sudo tar -xf libs.tar.xz -C / opt
        rm -f libs.tar.xz

    - name: Remove homebrew
      run: |
        echo "/opt/R/${ARCH}/bin" >> $GITHUB_PATH
        echo "LDFLAGS=-L/opt/R/${ARCH}/lib" >> $GITHUB_ENV
        echo "CPPFLAGS=-I/opt/R/${ARCH}/include" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/opt/R/${ARCH}/lib/pkgconfig:/opt/R/${ARCH}/share/pkgconfig" >> $GITHUB_ENV
        echo "/Library/TeX/texbin" >> $GITHUB_PATH
        echo "/usr/local/opt/texinfo/bin" >> $GITHUB_PATH
        cp -fv $(which wget) "/opt/R/${ARCH}/bin"
        brew unlink $(brew list --formula) || true

    - name: Install CRAN fortran build
      run: |
        curl --retry 3 -fsSLO https://github.com/R-macos/gcc-12-branch/releases/download/12.2-darwin-r0.1/gfortran-12.2-universal.pkg
        sudo installer -pkg "gfortran-12.2-universal.pkg" -target /
        rm -f gfortran-12.2-universal.pkg
        echo "/opt/gfortran/bin" >> $GITHUB_PATH
        echo "FC=/opt/gfortran/bin/gfortran" >> $GITHUB_ENV

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 100

    - name: Prepare
      run: |
        sed -i.bak 's|$(GIT) svn info|./.github/scripts/svn-info.sh|' Makefile.in
        ./.github/scripts/wget-recommended.sh
        ./.github/scripts/svn-info.sh

    - name: Configure
      run: CC=clang ./configure --prefix=/opt/R/${ARCH}/r-devel --disable-java --with-cairo --without-tcltk --without-x --with-aqua $ACCELERATE --enable-R-shlib SED=/usr/bin/sed
      env:
        PDFLATEX: ${{github.workspace}}/.github/scripts/dummy
        ACCELERATE: ${{ matrix.OS != 'macOS-13' && '--with-lapack --with-blas' || '' }}

    - name: Build
      run: make
      env:
        PDFLATEX: ${{github.workspace}}/.github/scripts/dummy

    - name: Install
      run: |
        mkdir -p /opt/R/${ARCH}/r-devel
        make install DESTDIR="/opt/R/${ARCH}/r-devel"
        (cd /opt/R/${ARCH}/r-devel; tar cfJ "/opt/R/r-devel-${ARCH}.tar.xz" .)

    - uses: actions/upload-artifact@v4
      with:
        name: MacOS-R-devel-${{ env.ARCH }}
        path: /opt/R/r-devel-${{ env.ARCH }}.tar.xz

    - name: Check
      run: make check-all
      env:
        PDFLATEX: ${{github.workspace}}/.github/scripts/dummy

    - name: Print failed tests
      if: always()
      run: tail -n100 tests/*.fail || true

  windows:
    name: Windows
    runs-on: ${{ matrix.arch == 'arm' && 'windows-11-arm' || 'windows-latest' }}
    timeout-minutes: 120
    env:
      R_CRAN_WEB: "https://cran.rstudio.com"
      CRAN_RSYNC: 'mirrors.nic.cz::CRAN'
    defaults:
      run:
        # Use Rtools45's built-in MSYS2 bash (per CRAN howto-R-devel.html)
        shell: C:\rtools45\usr\bin\bash.exe --login -eo pipefail {0}
    strategy:
      fail-fast: false
      matrix:
        script: [ 'check', 'installer' ]
        arch: [ 'intel', 'arm' ]
    steps:
    - name: Prepare git
      run: git config --global core.autocrlf false
      shell: bash

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 100

    - name: Install Rtools45 (per CRAN howto)
      shell: powershell
      run: |
        $arch = "${{ matrix.arch }}"
        $baseUrl = "https://cran.r-project.org/bin/windows/Rtools/rtools45/files/"

        # Fetch directory listing and find latest rtools45 installer
        Write-Host "Fetching available Rtools45 versions from: $baseUrl"
        $page = Invoke-WebRequest -Uri $baseUrl -UseBasicParsing

        if ($arch -eq "arm") {
          # Match: rtools45-aarch64-MAJOR-MINOR.exe
          $pattern = 'rtools45-aarch64-(\d+)-(\d+)\.exe'
        } else {
          # Match: rtools45-MAJOR-MINOR.exe (exclude aarch64 via negative lookbehind)
          $pattern = '(?<!aarch64-)rtools45-(\d+)-(\d+)\.exe'
        }

        $matches = [regex]::Matches($page.Content, $pattern) |
          ForEach-Object { @{ File = $_.Value; Major = [int]$_.Groups[1].Value; Minor = [int]$_.Groups[2].Value } } |
          Sort-Object -Property @{Expression={$_.Major}; Descending=$true}, @{Expression={$_.Minor}; Descending=$true}

        if ($matches.Count -eq 0) {
          Write-Error "No Rtools45 installer found for arch=$arch"
          exit 1
        }

        $latest = $matches[0]
        $url = "$baseUrl$($latest.File)"
        Write-Host "Found latest Rtools45: $($latest.File) (version $($latest.Major)-$($latest.Minor))"
        Write-Host "Downloading from: $url"

        $installer = "$env:RUNNER_TEMP\rtools45-installer.exe"
        Invoke-WebRequest -Uri $url -OutFile $installer -UseBasicParsing
        Write-Host "Installing Rtools45 to C:\rtools45..."
        Start-Process -FilePath $installer -ArgumentList "/VERYSILENT","/SUPPRESSMSGBOXES","/DIR=C:\rtools45" -Wait -NoNewWindow
        Write-Host "Rtools45 installed"

        # Export versions for Tcl/Tk download
        echo "RTOOLS_MAJOR=$($latest.Major)" >> $env:GITHUB_ENV
        echo "RTOOLS_MINOR=$($latest.Minor)" >> $env:GITHUB_ENV

    - name: Install InnoSetup
      if: matrix.script == 'installer'
      run: choco install -y --no-progress innosetup
      shell: cmd

    - name: Set timezone
      shell: powershell
      run: tzutil /s "GMT Standard Time"

    - name: Install MiKTeX
      shell: powershell
      run: |
        choco install -y --no-progress miktex
        # Refresh PATH
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        # Configure MiKTeX for auto-install of packages
        & "C:\Program Files\MiKTeX\miktex\bin\x64\initexmf.exe" --set-config-value [MPM]AutoInstall=1
        # Install inconsolata font (required per CRAN howto)
        & "C:\Program Files\MiKTeX\miktex\bin\x64\mpm.exe" --install=inconsolata

    - name: Download Tcl/Tk bundle (per CRAN howto)
      shell: powershell
      run: |
        $arch = "${{ matrix.arch }}"
        $rtoolsMajor = "${{ env.RTOOLS_MAJOR }}"
        $rtoolsMinor = "${{ env.RTOOLS_MINOR }}"
        $baseUrl = "https://cran.r-project.org/bin/windows/Rtools/rtools45/files/"

        # Tcl/Tk bundle uses same MAJOR-MINOR version as Rtools
        if ($arch -eq "arm") {
          $tcltkFile = "tcltk-aarch64-$rtoolsMajor-$rtoolsMinor.zip"
        } else {
          $tcltkFile = "tcltk-$rtoolsMajor-$rtoolsMinor.zip"
        }

        $url = "$baseUrl$tcltkFile"
        Write-Host "Downloading Tcl/Tk: $tcltkFile"
        Write-Host "URL: $url"

        Invoke-WebRequest -Uri $url -OutFile "tcltk.zip" -UseBasicParsing
        Expand-Archive -Path "tcltk.zip" -DestinationPath "." -Force
        Remove-Item "tcltk.zip"

    - name: Build and Check
      run: |
        cd "$(cygpath ${GITHUB_WORKSPACE})"

        # Set PATH per CRAN howto-R-devel.html
        if [ "${{ matrix.arch }}" = "arm" ]; then
          export PATH="/aarch64-w64-mingw32.static.posix/bin:$PATH"
        else
          export PATH="/x86_64-w64-mingw32.static.posix/bin:$PATH"
        fi
        # Add MiKTeX to PATH
        export PATH="$PATH:/c/Program Files/MiKTeX/miktex/bin/x64"

        # Set TAR variables per CRAN howto
        export TAR="/usr/bin/tar"
        export TAR_OPTIONS="--force-local"

        echo "PATH: $PATH"
        which make gcc pdflatex tar || true
        make --version
        gcc --version || clang --version

        # Prepare SVN build
        sed -i.bak 's|$(GIT) svn info|./.github/scripts/svn-info.sh|' Makefile.in
        sed -i.bak 's|$(GIT) svn info|./.github/scripts/svn-info.sh|' src/include/Makefile.win
        curl -sSL https://curl.se/ca/cacert.pem > etc/curl-ca-bundle.crt
        ./.github/scripts/wget-recommended.sh
        ./.github/scripts/svn-info.sh

        cd src/gnuwin32

        # Configure MkRules.local per CRAN howto
        echo 'ISDIR = C:/Program Files (x86)/Inno Setup 6' > MkRules.local
        if [ "${{ matrix.arch }}" = "arm" ]; then
          echo "USE_LLVM = 1" >> MkRules.local
          echo "WIN = " >> MkRules.local
        fi
        cat MkRules.local

        # Build per CRAN howto
        if [ "${{ matrix.script }}" = "installer" ]; then
          # Full build with installer
          make rsync-recommended
          make distribution
        else
          # Build and check
          make rsync-recommended
          make all recommended
          make check-all
        fi

    - name: Print failed tests
      if: failure() && matrix.script == 'check'
      run: tail -n100 tests/*.fail || true

    - name: Run Installer
      if: matrix.script == 'installer'
      shell: powershell
      run: .\src\gnuwin32\installer\R-devel-win.exe /SILENT

    - name: Upload installer artifact
      if: matrix.script == 'installer'
      uses: actions/upload-artifact@v4
      with:
        name: Windows-R-devel-${{ matrix.arch }}
        path: src/gnuwin32/installer/R-devel-win.exe
