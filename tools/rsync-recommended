#! /bin/sh
# ${R_HOME}/tools/rsync-recommended
# Fetch the recommended package tarballs over HTTPS and create
# version-agnostic .tgz links for the build.

set -e

CRAN_URL=${CRAN_URL:-https://cran.r-project.org}

TOOLS_DIR=$(
  cd "$(dirname "$0")" || exit 1
  pwd -P
)

fetch_to () {
  url=$1
  dest=$2
  if command -v curl >/dev/null 2>&1 ; then
    curl -fLSs --retry 2 -o "${dest}" "${url}"
  elif command -v wget >/dev/null 2>&1 ; then
    wget -q -O "${dest}" "${url}"
  else
    echo "*** need curl or wget to download ${url}" 1>&2
    return 1
  fi
}

pkg_version () {
  pkg=$1
  awk -v pkg="${pkg}" '
    tolower($1)=="package:" {p=$2}
    tolower($1)=="version:" && p==pkg {print $2; exit}
  ' "${INDEX}"
}

link_or_copy () {
  target=$1
  link=$2
  ln -sf "${target}" "${link}" 2>/dev/null || cp -f "${target}" "${link}"
}

(cd "${TOOLS_DIR}"/..
  version=$(cut -f1 -d' ' VERSION)
  if test "$(cut -f2 -d' ' VERSION)" = "Patched"; then
    version=$(echo "${version}" | sed 's/\.[0-9]*$//')
    version="${version}-patched"
  fi
  PKGS=$(grep '^R_PKGS_RECOMMENDED *= *' share/make/vars.mk | sed 's/.*=//')
  cd src/library/Recommended

  BASE="${CRAN_URL%/}/src/contrib/${version}/Recommended"
  WORK=${TMPDIR:-/tmp}
  WORK=$(mktemp -d "${WORK%/}/r-rec.XXXXXX")
  trap 'rm -rf "${WORK}"' EXIT INT HUP TERM

  INDEX="${WORK}/PACKAGES"
  if fetch_to "${BASE}/PACKAGES.gz" "${WORK}/PACKAGES.gz" ; then
    gzip -dc "${WORK}/PACKAGES.gz" > "${INDEX}"
  elif fetch_to "${BASE}/PACKAGES" "${INDEX}" ; then
    :
  else
    echo "*** unable to download PACKAGES index from ${BASE}" 1>&2
    exit 1
  fi

  rm -f *.tgz
  KEPT=""

  for i in ${PKGS} ; do
    ver=$(pkg_version "${i}")
    if test -z "${ver}" ; then
      echo "*** no version entry for ${i} in ${BASE}/PACKAGES" 1>&2
      exit 1
    fi
    tarball="${i}_${ver}.tar.gz"
    echo "Fetching ${tarball}"
    if ! fetch_to "${BASE}/${tarball}" "${WORK}/${tarball}"; then
      echo "*** failed to download ${tarball}" 1>&2
      exit 1
    fi
    mv "${WORK}/${tarball}" "${tarball}"
    link_or_copy "${tarball}" "${i}.tgz"
    KEPT="${KEPT} ${tarball}"
  done

  for f in *.tar.gz ; do
    case "${f}" in
      '*.tar.gz') break ;;
    esac
    case " ${KEPT} " in
      *" ${f} "*) ;;
      *) rm -f "${f}" ;;
    esac
  done
)
